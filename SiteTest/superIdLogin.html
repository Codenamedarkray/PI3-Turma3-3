<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Login com SuperID</title>
  <link rel="stylesheet" href="assets/styles/main.css">
</head>
<body>
  <h1>Login com SuperID</h1>
  <p>Escaneie o QR Code com o app SuperID</p>

  <img id="qrcode" src="" alt="QR Code carregando..." />
  <div id="status">Aguardando escaneamento...</div>

  <script>
    const PROJECT_ID = "super-id-f18ec"; 
    const API_KEY = "f6UIj/l23X+M4xW7yZ9aQ0bVpEs6iYdZgB8nJt2HuKl9rSwzXcAe5oPq1I7b8UjYn2OmLwzXcAe5oPq1I7b8e5oPq1I7b8UjYn2OmLwzXcAe5oPq1I7b8UjYn2OmLw==";
    const SITE_URL = "www.example.com";

    let loginToken = null;
  let pollInterval = null;
  let pollCount = 0;
  const MAX_POLLS = 4;
  const POLL_INTERVAL_MS = 15000; // 15 segundos

  async function generateQRCode() {
    try {
      const res = await fetch(`http://localhost:5001/${PROJECT_ID}/us-central1/performAuth`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          apiKey: API_KEY,
          url: SITE_URL
        })
      });

      const data = await res.json();
      loginToken = await data.loginToken;
      console.log("Login Token:", loginToken);

      document.getElementById("qrcode").src = data.qrBase64;
      document.getElementById("status").innerText = "Escaneie com o app SuperID";

      pollCount = 0;
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(checkLoginStatus, POLL_INTERVAL_MS);

    } catch (err) {
      document.getElementById("status").innerText = "Erro ao gerar QR Code";
      console.error(err);
    }
  }

  async function checkLoginStatus() {

    try {
      const res = await fetch(`http://localhost:5001/${PROJECT_ID}/us-central1/getLoginStatus`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ loginToken })
      });

      const data = await res.json();

      if (data.status === "success") {
        clearInterval(pollInterval);
        document.getElementById("status").innerText = "Login efetuado com sucesso!";
        setTimeout(() => {
          document.getElementById("status").innerText = "Usuário logado com sucesso!";
        }, 1000);
      } else if (data.status === "expired") {
        clearInterval(pollInterval);
        document.getElementById("status").innerText = "Token expirado. Gerando novo QR Code...";
        setTimeout(generateQRCode, 1000);
      } else {
        pollCount++;
        if (pollCount >= MAX_POLLS) {
          clearInterval(pollInterval);
          document.getElementById("status").innerText = "Tempo esgotado. Gerando novo QR Code...";
          setTimeout(generateQRCode, 1000);
        }
      }

    } catch (err) {
      clearInterval(pollInterval);
      document.getElementById("status").innerText = "Erro ao verificar status";
      console.error(err);
    }
  }

  // Gera QR Code ao abrir a página
  generateQRCode();
  </script>
</body>
</html>